(function(a){var b,c,d;b=a.extend({formSelector:".wc-box-office-ticket-form",templateDOMSelector:".wc-box-office-ticket-fields:first",fieldsTemplate:{}},ticketFormParams),c=Backbone.View.extend({initialize:function(){this.qty=b.is_admin?a("[name=\"quantity\"]"):this.$el.parent().find("[name=\"quantity\"]:first"),this.qty.on("change",a.proxy(this.updateQty,this)),this.addToCart=a(".wc-box-office-ticket-form").parent().find(".single_add_to_cart_button"),this.tickets=[],this.prevTicketEls=[]},updateQty:function(){this.removeTickets(),this.render()},render:function(){var c=parseInt(this.qty.val(),10),e=0;this.qty.length||(c=1);for(var f,g=0;g<c;g++){if(f=new d({index:g,parent:this}),this.tickets.push(f),this.$el.append(f.render().el),b.posted_data&&b.posted_data[g])for(var h in b.posted_data[g]){var j=b.posted_data[g][h];j&&this.setElValue(a("[id^=\"field_"+h+"\"]",f.$el),j)}if(this.prevTicketEls[g]){var k=this.prevTicketEls[g].hasClass("active");k&&(f.toggle(),e+=1),this.copyValuesFromPreviousElement(g)}}return b.posted_data=[],!e&&this.tickets[0]&&this.tickets[0].toggle(),this.updateAddToCartText(),this},copyValuesFromPreviousElement:function(b){var c=this;a(".ticket-field-input",this.prevTicketEls[b]).each(function(){var b=a(this).attr("id"),d=a(this).val();d&&c.setElValue(a("#"+b,this.$el),d)})},setElValue:function(b,c){switch(b.prop("nodeName")){case"INPUT":"radio"===b.attr("type")?b.each(function(){a(this).prop("checked",c===this.value)}):b.val(c);break;default:b.val(c);}},removeTickets:function(){for(;this.prevTicketEls.length;)this.prevTicketEls.pop().remove();for(;this.tickets.length;){var a=this.tickets.shift();this.prevTicketEls.push(a.$el.clone()),a.remove()}},updateAddToCartText:function(){var a=parseInt(this.qty.val(),10),c=b.i18n_add_to_cart_singular;1<a&&(c=b.i18n_add_to_cart_plural),this.addToCart.text(c)}}),d=Backbone.View.extend({tagName:"div",active:!1,className:"wc-box-office-ticket-fields",events:{"click .wc-box-office-ticket-fields-title a":"toggle"},initialize:function(a){this.index=a.index||0,this.parent=a.parent},toggle:function(a){this.active=!this.active,this.$el.toggleClass("active",this.active),a&&a.preventDefault()},render:function(){return this.$el.html(b.getFieldsTemplate(this.parent)),this.updateFieldIndex(),this.updateTitle(),this},updateFieldIndex:function(){var c=this.$el,d=a("[name^=\""+b.field_name_prefix+"\"]",c),e=this.index;d.each(function(){var d=a(this).attr("name").substr(b.field_name_prefix.length),f=b.field_name_prefix.replace("[0]","["+e+"]")+d,g=a(this).attr("id"),h=g?g+"_"+e:"";a(this).attr("name",f),a(this).attr("id",h),a("label[for=\""+g+"\"]",c).attr("for",h)}),this.$el.attr("data-index",e)},updateTitle:function(){a(".wc-box-office-ticket-fields-title a",this.$el).html(b.i18n_ticket_title_prefix+(this.index+1))}}),b.getFieldsTemplate=function(a){if(!b.fieldsTemplate[a.cid]&&a.$el.find(b.templateDOMSelector).length){var c=a.$el.find(b.templateDOMSelector);b.fieldsTemplate[a.cid]=c.clone().removeAttr("style").html(),c.remove()}return b.fieldsTemplate[a.cid]},b.run=function(){a(b.formSelector).each(function(){var b=a(this);new c({el:b}).render()})},a(b.run)})(jQuery);